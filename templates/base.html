<!DOCTYPE html>
<!--
    File: base.html
    Purpose: Master template for GenCon SG web application
    Description: Base template that all other pages extend. Includes Bootstrap 5,
                 Font Awesome icons, role-specific navigation, and accessibility features.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Page title - can be overridden by child templates -->
    <title>{% block title %}GenCon SG{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">

    <!-- Bootstrap 5 CSS CDN for responsive design and UI components -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome 6 for icons (user, bell, heart, message, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts - Poppins for modern, readable typography -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Main global CSS - contains CSS variables, utility classes, and base styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <!-- Role-specific CSS - loaded based on user role (senior, youth, admin) -->
    {% if session.role == 'senior' %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/senior.css') }}">
    {% elif session.role == 'youth' %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/youth.css') }}">
    {% elif session.role == 'admin' %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    {% endif %}

    <!-- Additional CSS block for child templates -->
    {% block extra_css %}{% endblock %}
</head>

<!-- Body class changes based on user role and theme settings -->
<body class="{% block body_class %}{% endblock %}"
      data-role="{{ session.role if session.role else 'guest' }}"
      data-theme="{{ session.theme if session.theme else 'light' }}">

    {% block background_animation %}{% endblock %}

    <!-- Navigation Bar - Role-specific -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container-fluid">
            <!-- Brand/Logo -->
            <a class="navbar-brand d-flex align-items-center" href="{% if session.role %}{{ url_for(session.role + '.dashboard') }}{% else %}{{ url_for('index') }}{% endif %}">
                <i class="fas fa-hands-helping text-primary me-2 fs-2"></i>
                <span class="fw-bold fs-3">GenCon SG</span>
            </a>

            <!-- Mobile hamburger toggle button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation links - only show if user is logged in -->
            <div class="collapse navbar-collapse" id="navbarNav">
                {% if session.user_id %}
                    <!-- Senior Navigation -->
                    {% if session.role == 'senior' %}
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('senior.dashboard') }}">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('senior.stories') }}">
                                <i class="fas fa-book"></i> My Stories
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('senior.messages') }}">
                                <i class="fas fa-comments"></i> Messages
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('senior.events') }}">
                                <i class="fas fa-calendar"></i> Events
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('senior.communities') }}">
                                <i class="fas fa-users"></i> Communities
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('senior.games') }}">
                                <i class="fas fa-gamepad"></i> Games
                            </a>
                        </li>
                    </ul>

                    <!-- Youth Navigation -->
                    {% elif session.role == 'youth' %}
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.dashboard') }}">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.story_feed') }}">
                                <i class="fas fa-book-open"></i> Stories
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.messages') }}">
                                <i class="fas fa-comments"></i> Messages
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.events') }}">
                                <i class="fas fa-calendar"></i> Events
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.communities') }}">
                                <i class="fas fa-users"></i> Communities
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.badges') }}">
                                <i class="fas fa-trophy"></i> Badges
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="{{ url_for('youth.games') }}">
                                <i class="fas fa-gamepad"></i> Games
                            </a>
                        </li>
                    </ul>

                    <!-- Admin Navigation -->
                    {% elif session.role == 'admin' %}
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item me-3">
                            <a class="nav-link fs-5" href="{{ url_for('admin.dashboard') }}">
                                <i class="fas fa-chart-line"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link fs-5" href="{{ url_for('admin.users') }}">
                                <i class="fas fa-user-friends"></i> Users
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link fs-5" href="{{ url_for('admin.pairs') }}">
                                <i class="fas fa-link"></i> Pairs
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link fs-5" href="{{ url_for('admin.events') }}">
                                <i class="fas fa-calendar-alt"></i> Events
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link fs-5" href="{{ url_for('admin.communities') }}">
                                <i class="fas fa-users-cog"></i> Communities
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link fs-5" href="{{ url_for('admin.reports') }}">
                                <i class="fas fa-flag"></i> Reports
                            </a>
                        </li>
                    </ul>
                    {% endif %}

                    <!-- Right-side navigation items (notifications, profile, etc.) -->
                    <ul class="navbar-nav ms-auto">
                        <!-- Event Notifications Bell (for seniors and youth only) -->
                        {% if session.role in ['senior', 'youth'] %}
                        <li class="nav-item dropdown d-flex align-items-center me-3">
                            <a class="nav-link position-relative" href="#" id="notificationDropdown"
                               role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-bell fs-5"></i>
                                <!-- Notification badge - shows count of unread notifications -->
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                      id="notificationBadge" style="font-size: 0.7rem;">
                                    0
                                </span>
                            </a>
                            <!-- Notification dropdown menu -->
                            <ul class="dropdown-menu dropdown-menu-end notification-dropdown"
                                style="width: 300px; max-height: 400px; overflow-y: auto;">
                                <li class="dropdown-header">Event Notifications</li>
                                <li><hr class="dropdown-divider"></li>
                                <!-- Notifications will be dynamically loaded here via JavaScript -->
                                <li id="notificationList">
                                    <p class="text-muted text-center py-3 mb-0">No new notifications</p>
                                </li>
                            </ul>
                        </li>

                        <!-- Daily Streak Display (for seniors and youth) -->
                        <li class="nav-item d-flex align-items-center me-3">
                            <i class="fas fa-fire text-warning me-1"></i>
                            <span class="fw-bold" id="streakCount">{{ user_streak|default(0) }}</span>
                            <small class="text-muted ms-1">day streak</small>
                        </li>
                        {% endif %}

                        <!-- User Profile Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#"
                               id="profileDropdown" role="button" data-bs-toggle="dropdown"
                               aria-expanded="false">
                                
                                {% if 'default-avatar' in session.get('profile_picture', 'default-avatar.png') %}
                                    <div class="avatar-placeholder sm me-2">
                                        {{ session.get('full_name', 'U')[0] | upper }}
                                    </div>
                                {% else %}
                                    <img src="{{ url_for('static', filename=session.get('profile_picture')|fix_pfp) }}" 
                                         alt="User" 
                                         class="rounded-circle me-2" 
                                         width="32" height="32" 
                                         style="object-fit: cover;">
                                {% endif %}
                                {{ session.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for(session.role + '.profile') }}">
                                        <i class="fas fa-user me-2"></i>My Profile
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                {% else %}
                    <!-- Guest Navigation (not logged in) -->
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item me-2">
                            <a class="btn btn-outline-primary" href="{{ url_for('auth.login') }}">
                                <i class="fas fa-sign-in-alt me-1"></i>Login
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-primary" href="{{ url_for('auth.register') }}">
                                <i class="fas fa-user-plus me-1"></i>Sign Up
                            </a>
                        </li>
                    </ul>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Flash Messages - Display success/error/info messages to user -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {% if category == 'success' %}
                            <i class="fas fa-check-circle me-2"></i>
                        {% elif category == 'danger' %}
                            <i class="fas fa-exclamation-circle me-2"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-triangle me-2"></i>
                        {% else %}
                            <i class="fas fa-info-circle me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content Area - Child templates inject content here -->
    <main class="main-content">
        {% block content %}
        <!-- Page-specific content goes here -->
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="fw-bold mb-3">GenCon SG</h5>
                    <p class="text-muted small">
                        Bridging generations through meaningful connections,
                        storytelling, and cultural exchange.
                    </p>
                </div>
                <div class="col-md-4">
                    <h6 class="fw-bold mb-3">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-muted text-decoration-none small">About Us</a></li>
                        <li><a href="#" class="text-muted text-decoration-none small">Help & Support</a></li>
                        <li><a href="#" class="text-muted text-decoration-none small">Privacy Policy</a></li>
                        <li><a href="#" class="text-muted text-decoration-none small">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="fw-bold mb-3">Contact</h6>
                    <p class="text-muted small mb-1">
                        <i class="fas fa-envelope me-2"></i>support@genconsg.com
                    </p>
                    <p class="text-muted small mb-1">
                        <i class="fas fa-phone me-2"></i>+65 1234 5678
                    </p>
                    <ul class="social-media-icons d-flex mt-3">
                        <li>
                            <a href="#">
                                <i class="fab fa-facebook-f icon"></i>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fab fa-twitter icon"></i>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fab fa-linkedin-in icon"></i>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fab fa-google-plus-g icon"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center text-muted small">
                <p class="mb-0">&copy; 2025 GenCon SG. All rights reserved. | Developed by Team Rai for NYP Web Development Project</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JavaScript Bundle (includes Popper for dropdowns, tooltips, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main JavaScript file with global utility functions -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Socket.IO Global Notifications -->
    {% if session.user_id %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        const globalSocket = io();
        
        // Initialize notification listener
        if (window.initNotificationSocket) {
            window.initNotificationSocket(globalSocket);
        }

        globalSocket.on('game_challenge', function(data) {
            console.log("Received challenge:", data);
            // Refresh navbar notifications
            if (typeof loadNotifications === 'function') {
                loadNotifications();
            }
            
            // Construct redirect URL based on role and game title
            var role = document.body.getAttribute('data-role');
            var gameUrl = '';
            var gameEndpoint = 'chess_game';
            
            if (data.game_title && data.game_title.includes('Xiangqi')) {
                gameEndpoint = 'xiangqi_game';
            }
            
            if (role === 'senior') {
                // We construct the URL manually because url_for is server-side
                // Using a base path assumption or if possible injecting both URLs
                gameUrl = (gameEndpoint === 'xiangqi_game') ? "{{ url_for('senior.xiangqi_game') }}" : "{{ url_for('senior.chess_game') }}";
            } else if (role === 'youth') {
                gameUrl = (gameEndpoint === 'xiangqi_game') ? "{{ url_for('youth.xiangqi_game') }}" : "{{ url_for('youth.chess_game') }}";
            }
            
            gameUrl += "?session_id=" + data.session_id;

            // Show interactive toast
            if (typeof showToast === 'function') {
                showToast(
                    data.challenger_name + ' challenged you to ' + data.game_title + '!', 
                    'info',
                    gameUrl,
                    'Join Game'
                );
            }
        });
    </script>
    {% endif %}

    <!-- Additional JavaScript block for child templates -->
    {% block extra_js %}{% endblock %}

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm">
                        <input type="hidden" id="reportMessageId">
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <select class="form-select" id="reportReason" required>
                                <option value="" selected disabled>Select a reason...</option>
                                <option value="Harassment">Harassment or Bullying</option>
                                <option value="Inappropriate">Inappropriate Content</option>
                                <option value="Spam">Spam or Scam</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="reportDescription" rows="3" placeholder="Provide more details..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="submitReport()">Submit Report</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
