{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ url_for('admin.reports') }}" class="btn btn-outline-secondary mb-2">
                <i class="fas fa-arrow-left me-2"></i>Back to Reports
            </a>
            <h2>Report Details #{{ report.id }}</h2>
        </div>
        <div>
            <span class="badge bg-{{ 'warning' if report.status == 'pending' else 'success' if report.status == 'resolved' else 'secondary' }} fs-5">
                {{ report.status|capitalize }}
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Report Info -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Report Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Reason:</strong> <span class="text-danger">{{ report.reason }}</span></p>
                    <p><strong>Description:</strong> {{ report.description or 'No description provided.' }}</p>
                    <p><strong>Reported By:</strong> {{ report.reporter.full_name }} ({{ report.reporter.role }})</p>
                    <p><strong>Reported User:</strong> {{ report.reported_user.full_name }} ({{ report.reported_user.role }})</p>
                    <p><strong>Date:</strong> {{ report.created_at|timeago }}</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label class="form-label">Admin Notes</label>
                            <textarea name="admin_notes" class="form-control" rows="3">{{ report.admin_notes or '' }}</textarea>
                        </div>
                        
                        <div class="d-grid gap-2">
                            {% if report.status != 'resolved' %}
                            <button type="submit" name="action" value="resolve" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>Mark as Resolved
                            </button>
                            {% endif %}
                            
                            {% if report.status != 'dismissed' %}
                            <button type="submit" name="action" value="dismiss" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Dismiss Report
                            </button>
                            {% endif %}
                            
                            {% if report.status != 'under_review' %}
                            <button type="submit" name="action" value="under_review" class="btn btn-warning">
                                <i class="fas fa-search me-2"></i>Mark Under Review
                            </button>
                            {% endif %}
                        </div>
                    </form>
                    
                    <hr>
                    
                    <!-- User Moderation -->
                    <h6 class="text-danger mb-3">User Moderation</h6>
                    <form action="{{ url_for('admin.toggle_user_status', user_id=report.reported_user.id) }}" method="POST" onsubmit="return confirm('Are you sure? This will prevent the user from logging in.');">
                        <input type="hidden" name="reason" value="Account disabled due to report #{{ report.id }}: {{ report.reason }}">
                        {% if report.reported_user.is_active %}
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="fas fa-ban me-2"></i>Disable User Account
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-outline-success w-100">
                            <i class="fas fa-check-circle me-2"></i>Enable User Account
                        </button>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Chat Context -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversation Context</h5>
                    <small class="text-muted">Last 20 messages</small>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                        {% for msg in history %}
                        <div class="list-group-item {{ 'bg-warning bg-opacity-10' if msg.id == report.message_id else '' }}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>
                                        {% if msg.sender_id == report.reported_user_id %}
                                            <span class="text-danger">{{ msg.sender.full_name }} (Reported)</span>
                                        {% else %}
                                            <span class="text-primary">{{ msg.sender.full_name }}</span>
                                        {% endif %}
                                    </strong>
                                    <small class="text-muted ms-2">{{ msg.created_at|timeago }}</small>
                                </div>
                                {% if msg.id == report.message_id %}
                                <span class="badge bg-danger">Reported Message</span>
                                {% endif %}
                            </div>
                            <p class="mb-1 mt-1">{{ msg.content }}</p>
                            {% if msg.is_flagged %}
                            <div class="text-warning small"><i class="fas fa-exclamation-triangle"></i> Flagged by system</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}