{% extends "base.html" %}
<!--
    File: youth/messages.html
    Purpose: Messaging interface for youth to chat with their senior buddy
    Author: to be assigned
    Date: December 2025
    Feature: Lingo Bridge Messaging (RAI's Feature Part 2)
-->

{% block title %}Messages - GenCon SG{% endblock %}

{% block body_class %}messages-page{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-9 mx-auto">
            {% if buddy %}
            <div class="modern-chat-interface">
                <!-- Simple Header -->
                <div class="chat-header-minimal d-flex align-items-center mb-4">
                    <div class="position-relative">
                        <img src="{{ url_for('static', filename=buddy.profile_picture|fix_pfp) }}"
                             alt="{{ buddy.full_name }}"
                             class="rounded-circle border border-2 border-primary shadow-sm"
                             style="width: 65px; height: 60px; object-fit: cover;">
                        <span class="status-dot online"></span>
                    </div>
                    <div class="ms-3 flex-grow-1">
                        <h4 class="mb-0 fw-bold">{{ buddy.full_name }}</h4>
                        <span class="badge bg-light text-primary border">Buddy Conversation</span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-white border rounded-pill shadow-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-language me-2 text-primary"></i>Translate
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
                            <li><h6 class="dropdown-header">Auto-Translate to:</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('en')">üá¨üáß English</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('zh')">üá®üá≥ Chinese</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('ms')">üá≤üáæ Malay</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('ta')">üáÆüá≥ Tamil</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Ghost Message Area (No outer box) -->
                <div class="message-feed" id="chatMessages">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="message-wrapper {% if message.sender_id == session.user_id %}me{% else %}other{% endif %}">
                            <div class="message-bubble">
                                {% if message.is_flagged %}
                                <div class="flagged-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <small>Content flagged</small>
                                </div>
                                {% endif %}

                                <div class="content-text">{{ message.content }}</div>

                                {% if message.translated_content and message.original_language != 'en' %}
                                <div class="translation-text">
                                    <i class="fas fa-language"></i> {{ message.translated_content }}
                                </div>
                                {% endif %}
                                <div class="time-stamp">{{ message.created_at|format_date('%I:%M %p') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-chat-state text-center py-5">
                            <div class="icon-circle mb-3 shadow-sm"><i class="fas fa-comments"></i></div>
                            <h5 class="text-dark">No messages yet</h5>
                            <p class="text-muted">Say hello to your buddy {{ buddy.full_name.split(' ')[0] }}!</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Floating Input Bar -->
                <div class="input-area-modern mt-4">
                    <form id="messageForm" method="POST" action="{{ url_for('youth.messages') }}">
                        <div class="pill-input-wrapper shadow-sm">
                            <button class="btn emoji-trigger" type="button" data-bs-toggle="dropdown">
                                <i class="far fa-smile"></i>
                            </button>
                            <div class="dropdown-menu sticker-menu p-3 border-0 shadow">
                                <div class="sticker-grid">
                                    <span class="sticker" onclick="insertSticker('üëç')">üëç</span>
                                    <span class="sticker" onclick="insertSticker('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                                    <span class="sticker" onclick="insertSticker('üòä')">üòä</span>
                                    <span class="sticker" onclick="insertSticker('üëè')">üëè</span>
                                    <span class="sticker" onclick="insertSticker('üôè')">üôè</span>
                                    <span class="sticker" onclick="insertSticker('üéâ')">üéâ</span>
                                    <span class="sticker" onclick="insertSticker('üåü')">üåü</span>
                                    <span class="sticker" onclick="insertSticker('üíØ')">üíØ</span>
                                </div>
                            </div>

                            <textarea class="form-control auto-expand"
                                   id="messageInput"
                                   name="message"
                                   placeholder="Type a message..."
                                   rows="1"
                                   required></textarea>

                            <button class="btn circle-send-btn" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between mt-2 px-3">
                            <small class="text-muted"><i class="fas fa-shield-alt text-success me-1"></i> Encryption Active</small>
                            <button type="button" class="btn btn-link btn-sm text-danger p-0 text-decoration-none" data-bs-toggle="modal" data-bs-target="#reportModal">
                                <i class="fas fa-flag me-1"></i>Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% else %}
            <!-- No Buddy Placeholder -->
            <div class="card border-0 shadow-sm rounded-4 py-5">
                <div class="card-body text-center">
                    <div class="icon-circle mb-4 bg-light mx-auto" style="width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #ddd;">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <h3 class="fw-bold">No Buddy Assigned</h3>
                    <p class="text-muted mb-4">Pair with a senior to start meaningful conversations.</p>
                    <a href="{{ url_for('youth.dashboard') }}" class="btn btn-primary rounded-pill px-5 py-3">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .modern-chat-interface {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 180px);
    }

    .status-dot {
        width: 14px;
        height: 14px;
        background: #2ecc71;
        border: 3px solid white;
        border-radius: 50%;
        position: absolute;
        bottom: 2px;
        right: 2px;
    }

    .message-feed {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        background: rgba(255,255,255,0.5);
        border-radius: 2rem;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .message-wrapper {
        display: flex;
        width: 100%;
    }

    .message-wrapper.me { justify-content: flex-end; }
    .message-wrapper.other { justify-content: flex-start; }

    .message-bubble {
        max-width: 75%;
        padding: 0.875rem 1.5rem;
        border-radius: 1.5rem;
        position: relative;
        font-size: 1.05rem;
        line-height: 1.5;
        box-shadow: 0 3px 10px rgba(0,0,0,0.03);
        width: fit-content;
    }

    .message-wrapper.me .message-bubble {
        background: linear-gradient(135deg, #9B59B6 0%, #3498DB 100%);
        color: white;
        border-bottom-right-radius: 0.3rem;
    }

    .message-wrapper.other .message-bubble {
        background: white;
        color: #2c3e50;
        border-bottom-left-radius: 0.3rem;
        border: 1px solid #eee;
    }

    .time-stamp {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 0.4rem;
        text-align: right;
    }

    .translation-text {
        font-size: 0.9rem;
        border-top: 1px solid rgba(255,255,255,0.2);
        margin-top: 0.6rem;
        padding-top: 0.5rem;
        font-style: italic;
    }

    .message-wrapper.other .translation-text {
        border-top-color: #eee;
        color: #666;
    }

    .pill-input-wrapper {
        background: white;
        border-radius: 3rem;
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border: 1px solid #e0e0e0;
        gap: 0.5rem;
    }

    .pill-input-wrapper:focus-within {
        border-color: #9B59B6;
        box-shadow: 0 8px 25px rgba(155, 89, 182, 0.1) !important;
    }

    .auto-expand {
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
        resize: none;
        max-height: 150px;
        padding: 0.75rem 0.5rem !important;
        font-size: 1.05rem;
        min-height: 45px;
    }

    .emoji-trigger {
        font-size: 1.6rem;
        color: #888;
        padding: 0.4rem;
        transition: color 0.2s;
    }

    .emoji-trigger:hover { color: #9B59B6; }

    .circle-send-btn {
        background: #9B59B6;
        color: white;
        width: 45px;
        height: 45px;
        min-width: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        padding: 0;
        border: none;
    }

    .circle-send-btn:hover {
        background: #3498DB;
        transform: scale(1.1) rotate(-10deg);
        color: white;
    }

    .icon-circle {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #9B59B6;
        margin: 0 auto;
    }

    .sticker-menu { width: 280px; border-radius: 1.5rem; }
    .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .sticker { font-size: 2rem; cursor: pointer; text-align: center; padding: 0.5rem; border-radius: 0.8rem; transition: all 0.2s; }
    .sticker:hover { background: #f8f9fa; transform: scale(1.2); }
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    function insertSticker(emoji) {
        const input = document.getElementById('messageInput');
        if (!input) return;
        input.value += emoji;
        input.focus();
        autoExpand(input);
    }

    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', function() { autoExpand(this); });
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('messageForm').submit();
            }
        });
    }

    function autoExpand(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function setLanguage(lang) {
        localStorage.setItem('translationLanguage', lang);
        if (typeof showToast === 'function') showToast('Language updated', 'success');
    }
    
    // Auto-scroll to bottom
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}